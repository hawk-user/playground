#!/bin/sh

set -e

msgFile="$1"

if [ -z "$msgFile" ]; then
    printf "\n\033[1;31m[commit-msg] ğŸš¨ ERROR: No commit message file provided!\033[0m\n\n"
    exit 1
fi

if ! command -v npx >/dev/null 2>&1; then
    printf "\n\033[1;31m[commit-msg] ğŸš¨ ERROR: npx is not installed. Please install Node.js & npm/pnpm.\033[0m\n\n"
    exit 1
fi

commitMsg=$(cat "$msgFile")
commitlintConfig="$(git rev-parse --show-toplevel)/.commitlintrc.yml"

if npx --no -- commitlint --config "$commitlintConfig" --edit "$msgFile"; then
    printf "\n\033[1;32m[commit-msg] ğŸ‘€ Commit message is valid!\033[0m\n"

    printf "\033[1;34mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m\n"
    printf "\033[1;34mâ•‘ %-36s â•‘\033[0m\n" "$commitMsg"
    printf "\033[1;34mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m\n"

    printf "\033[1;36m[commit-msg] âœ¨ Magic is everywhere! Happy committing!\033[0m\n\n"
else
    printf "\n\033[1;31m[commit-msg] ğŸš¨ Invalid commit message!\033[0m\n"
    printf "\033[33m[commit-msg] ğŸ’¡ Please follow the conventional commit format.\033[0m\n\n"
    exit 1
fi